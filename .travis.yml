# Setting up automatic travis test build.
sudo: required
branches:
  only:
  - master
  - dev

services:
  - docker

env:
  - VERSION=$(cat setup.py| grep version | tail -c 8 | cut -c 1-5)

jobs:
  include:
    - stage: build docker image
      name: "Build 3.6 image for testing"
      script:
      - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
      - docker pull divkal/cdt-env-base:1.0
      - Docker build --build-arg python=3.6 -t divkal/cdt-test .
      - docker push divkal/cdt-test
    - stage: test
      script: docker run --rm divkal/cdt-test /bin/sh -c 'cd /CDT && pytest --cov && codecov -t $CODECOV_TOKEN'
    - stage: deploy
      name: "Build and push 3.6"
      script:
      - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
      - docker pull divkal/cdt-test
      - docker tag divkal/cdt-test divkal/cdt-py3.6:$VERSION
      - docker push divkal/cdt-py3.6:$VERSION
    - script:
      - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
      - docker pull divkal/cdt-env-base:1.0
      - docker build --build-arg python=3.7 -t divkal/cdt-py3.7:$VERSION .
      - docker push divkal/cdt-py3.7:$VERSION
      name: "Build and push 3.7"
    - script:
      - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
      - docker pull divkal/nv-cdt-env-base:1.0
      - docker build -f nv-Dockerfile -t divkal/nv-cdt-py3.6:$VERSION .
      - docker push divkal/nv-cdt-py3.6:$VERSION .
      name: "Build and push nv-3.6"
